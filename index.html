<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pages API with CSV</title>
</head>
<body>
    <script>
        // Function to parse query parameters from the URL
        function getQueryParams() {
            const params = {};
            window.location.search
                .substring(1)
                .split('&')
                .forEach(pair => {
                    const [key, value] = pair.split('=');
                    params[decodeURIComponent(key)] = decodeURIComponent(value);
                });
            return params;
        }

        // Function to parse CSV data into an array of objects
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index];
                    return obj;
                }, {});
            });
        }

        // Function to convert array of objects back to CSV
        function convertToCSV(data) {
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(row => Object.values(row).join(','));
            return headers + '\n' + rows.join('\n');
        }

        // Fetch the CSV file and handle requests
        fetch('data.csv')
            .then(response => response.text())
            .then(csvData => {
                let dataStore = parseCSV(csvData);

                // Get query parameters
                const queryParams = getQueryParams();

                // Handle GET request
                if (queryParams.method === 'get') {
                    const id = queryParams.id;
                    const item = dataStore.find(item => item.id == id);
                    if (item) {
                        document.write(JSON.stringify({ success: true, data: item }));
                    } else {
                        document.write(JSON.stringify({ success: false, message: 'Item not found' }));
                    }
                }
                // Handle POST request
                else if (queryParams.method === 'post') {
                    const newItem = {
                        id: (dataStore.length + 1).toString(),
                        name: queryParams.name || 'Unnamed Item'
                    };
                    dataStore.push(newItem);

                    // Convert updated data back to CSV
                    const updatedCSV = convertToCSV(dataStore);

                    // Display the updated CSV (simulating a write operation)
                    document.write(JSON.stringify({
                        success: true,
                        message: 'Item added successfully',
                        data: newItem,
                        updatedCSV: updatedCSV
                    }));
                }
                // Invalid method
                else {
                    document.write(JSON.stringify({ success: false, message: 'Invalid method' }));
                }
            })
            .catch(error => {
                document.write(JSON.stringify({ success: false, message: 'Error fetching data', error: error.message }));
            });
    </script>
</body>
</html>
